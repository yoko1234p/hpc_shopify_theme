{% comment %}
  Company mode product detail page
  Matches React ProductPage.tsx styling for seal/company theme
{% endcomment %}

{%- assign current_variant = product.selected_or_first_available_variant -%}
{%- assign featured_image = current_variant.featured_image | default: product.featured_image -%}

<div class="min-h-screen bg-[#F9F9F9] py-8 px-4 md:px-8">
  <!-- Back Button -->
  <a
    href="/"
    class="mb-8 flex items-center gap-2 text-sm font-lhkk text-[#333333]/60 hover:text-[#333333] transition-colors"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    å›ä¸»é 
  </a>

  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
    <!-- Product Images -->
    <div class="space-y-4">
      <!-- Main Image -->
      <div class="aspect-square bg-white border border-[#EAEAEA] p-4 flex items-center justify-center">
        <img
          id="main-product-image"
          src="{{ featured_image | image_url: width: 800 }}"
          alt="{{ product.title | escape }}"
          class="max-w-full max-h-full object-contain"
        >
      </div>

      <!-- Thumbnail Gallery -->
      {%- if product.images.size > 1 -%}
        <div class="flex gap-2">
          {%- for image in product.images -%}
            <button
              type="button"
              class="thumbnail-btn w-20 h-20 border-2 p-1 transition-colors border-[#EAEAEA] hover:border-[#C83F49]"
              data-image-url="{{ image | image_url: width: 800 }}"
            >
              <img src="{{ image | image_url: width: 100 }}" alt="" class="w-full h-full object-contain">
            </button>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>

    <!-- Product Info -->
    <div class="space-y-6">
      <!-- Title & Price -->
      <div>
        <p class="text-xs tracking-widest uppercase mb-2 text-[#333333]/60">
          {{ product.type | default: product.vendor }}
        </p>
        <h1 class="text-3xl md:text-4xl font-bold mb-2 font-lhkk text-[#333333]">
          {{ product.title }}
        </h1>
        {%- if product.metafields.custom.name_en != blank -%}
          <p class="text-sm text-[#333333]/60">{{ product.metafields.custom.name_en }}</p>
        {%- endif -%}
      </div>

      <!-- Price -->
      <div class="flex items-baseline gap-4">
        <span class="text-3xl font-bold text-[#C83F49]">
          {{ current_variant.price | money }}
        </span>
        {%- if current_variant.compare_at_price > current_variant.price -%}
          <span class="text-lg line-through text-[#333333]/60">
            {{ current_variant.compare_at_price | money }}
          </span>
          {%- assign discount = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round -%}
          <span class="px-2 py-1 text-xs font-bold bg-red-100 text-[#C83F49]">
            -{{ discount }}%
          </span>
        {%- endif -%}
      </div>

      <!-- Description -->
      {%- if product.description != blank -%}
        <div class="text-base leading-relaxed text-[#333333] product-description-html">
          {{ product.description }}
        </div>
      {%- endif -%}

      <!-- Features (from metafield) -->
      {%- assign features = product.metafields.custom.features.value -%}
      {%- if features != blank -%}
        <div>
          <h3 class="text-sm font-bold mb-3 font-lhkk text-[#333333]">ç”¢å“ç‰¹è‰²</h3>
          <ul class="space-y-2">
            {%- for feature in features -%}
              <li class="flex items-center gap-2 text-sm text-[#333333]/60">
                <span class="text-[#C83F49]">âœ“</span>
                {{ feature }}
              </li>
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}

      <!-- Product Details -->
      <div class="text-sm text-[#333333]/60 space-y-2">
        {%- if product.metafields.custom.redemption_period != blank -%}
          <p><strong class="text-[#333333]">æ›é ˜æœŸï¼š</strong>{{ product.metafields.custom.redemption_period }}</p>
        {%- endif -%}
        {%- if product.metafields.custom.weight != blank -%}
          <p><strong class="text-[#333333]">é‡é‡ï¼š</strong>{{ product.metafields.custom.weight }}</p>
        {%- endif -%}
        {%- if product.metafields.custom.made_in != blank -%}
          <p><strong class="text-[#333333]">ç”¢åœ°ï¼š</strong>{{ product.metafields.custom.made_in }}</p>
        {%- endif -%}
      </div>

      <!-- Variant Selector (if applicable) -->
      {%- if product.has_only_default_variant == false -%}
        <div class="space-y-4">
          {%- for option in product.options_with_values -%}
            <div>
              <label class="text-sm font-bold text-[#333333] mb-2 block">{{ option.name }}</label>
              <select
                name="options[{{ option.name }}]"
                class="variant-selector w-full border-2 border-[#EAEAEA] p-3 text-[#333333] focus:border-[#C83F49] outline-none"
                data-option-index="{{ forloop.index0 }}"
              >
                {%- for value in option.values -%}
                  <option value="{{ value }}" {% if option.selected_value == value %}selected{% endif %}>
                    {{ value }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          {%- endfor -%}
        </div>
      {%- endif -%}

      <!-- Quantity & Add to Cart -->
      <form id="add-to-cart-form" class="flex flex-col sm:flex-row gap-4">
        <input type="hidden" name="id" value="{{ current_variant.id }}" id="variant-id">

        <!-- Quantity Selector -->
        <div class="flex items-center border-2 border-[#EAEAEA] rounded-lg overflow-hidden">
          <button
            type="button"
            class="qty-btn w-12 h-12 flex items-center justify-center hover:bg-[#F0F0F0] transition-all duration-200"
            data-action="decrease"
          >
            <svg class="w-5 h-5 text-[#333333]" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
            </svg>
          </button>
          <input
            type="number"
            name="quantity"
            value="1"
            min="1"
            class="qty-input w-14 text-center font-mono text-lg font-bold text-[#333333] border-none outline-none"
            readonly
          >
          <button
            type="button"
            class="qty-btn w-12 h-12 flex items-center justify-center hover:bg-[#F0F0F0] transition-all duration-200"
            data-action="increase"
          >
            <svg class="w-5 h-5 text-[#333333]" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>

        <!-- Add to Cart Button -->
        <button
          type="submit"
          class="flex-1 py-3 px-8 font-bold tracking-wider transition-all duration-300 bg-[#C83F49] hover:bg-[#B03A42] text-white"
          {% unless current_variant.available %}disabled{% endunless %}
        >
          {% if current_variant.available %}
            åŠ å…¥è³¼ç‰©è»Š
          {% else %}
            å”®ç½„
          {% endif %}
        </button>
      </form>

      <!-- Made in HK Badge -->
      <div class="flex items-center gap-2 pt-4">
        <span class="text-2xl">ğŸ‡­ğŸ‡°</span>
        <span class="text-sm text-[#333333]/60">100% é¦™æ¸¯è£½é€ </span>
      </div>
    </div>
  </div>

  <!-- Ingredients Section -->
  {%- assign ingredients = product.metafields.custom.ingredients.value -%}
  {%- if ingredients != blank -%}
    <div class="max-w-6xl mx-auto mt-16 pt-8 border-t border-[#EAEAEA]">
      <h2 class="text-xl font-bold mb-4 font-lhkk text-[#333333]">ä¸»è¦æˆåˆ†</h2>
      <div class="flex flex-wrap gap-2">
        {%- for ing in ingredients -%}
          <span class="px-3 py-1 text-sm border border-[#EAEAEA] text-[#333333]/60">
            {{ ing }}
          </span>
        {%- endfor -%}
      </div>
    </div>
  {%- endif -%}

  <!-- Related Products -->
  {%- if section.settings.show_related and product.collections.first != blank -%}
    {%- assign related_products = product.collections.first.products | where_not: 'id', product.id -%}
    {%- if related_products.size > 0 -%}
      <div class="max-w-6xl mx-auto mt-16 pt-8 border-t border-[#EAEAEA]">
        <h2 class="text-xl font-bold mb-6 font-lhkk text-[#333333]">ä½ å¯èƒ½é‚„æ„Ÿèˆˆè¶£çš„</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {%- for related in related_products limit: 2 -%}
            <a
              href="{{ related.url }}"
              class="group cursor-pointer flex gap-4 p-4 border border-[#EAEAEA] bg-white hover:shadow-lg transition-all duration-300"
            >
              <!-- Product Image -->
              <div class="w-24 h-24 flex-shrink-0 border border-[#EAEAEA] p-2 flex items-center justify-center">
                <img
                  src="{{ related.featured_image | image_url: width: 100 }}"
                  alt="{{ related.title | escape }}"
                  class="max-w-full max-h-full object-contain group-hover:scale-105 transition-transform duration-300"
                >
              </div>

              <!-- Product Info -->
              <div class="flex-1 flex flex-col justify-center">
                <p class="text-xs tracking-widest uppercase mb-1 text-[#333333]/60">
                  {{ related.type | default: related.vendor }}
                </p>
                <h3 class="text-lg font-bold mb-1 font-lhkk text-[#333333] group-hover:text-[#C83F49] transition-colors">
                  {{ related.title }}
                </h3>
                <div class="flex items-center gap-2">
                  <span class="font-bold text-[#C83F49]">{{ related.price | money }}</span>
                  {%- if related.compare_at_price > related.price -%}
                    <span class="text-sm line-through text-[#333333]/60">{{ related.compare_at_price | money }}</span>
                  {%- endif -%}
                </div>
              </div>

              <!-- Arrow -->
              <div class="flex items-center text-[#333333]/60 group-hover:text-[#C83F49] transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  {%- endif -%}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Thumbnail click handler
  document.querySelectorAll('.thumbnail-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('main-product-image').src = this.dataset.imageUrl;
      document.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('border-[#C83F49]'));
      this.classList.add('border-[#C83F49]');
    });
  });

  // Quantity buttons
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const input = document.querySelector('.qty-input');
      let value = parseInt(input.value);
      if (this.dataset.action === 'increase') {
        input.value = value + 1;
      } else if (this.dataset.action === 'decrease' && value > 1) {
        input.value = value - 1;
      }
    });
  });

  // Variant selector (if has variants)
  const variantSelectors = document.querySelectorAll('.variant-selector');
  if (variantSelectors.length > 0) {
    const productJson = {{ product.variants | json }};

    variantSelectors.forEach(select => {
      select.addEventListener('change', function() {
        const selectedOptions = Array.from(variantSelectors).map(s => s.value);
        const variant = productJson.find(v => {
          return v.options.every((opt, i) => opt === selectedOptions[i]);
        });
        if (variant) {
          document.getElementById('variant-id').value = variant.id;
          // Update price display if needed
        }
      });
    });
  }

  // AJAX Add to Cart
  const addToCartForm = document.getElementById('add-to-cart-form');
  if (addToCartForm) {
    addToCartForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const variantId = document.getElementById('variant-id').value;
      const quantity = document.querySelector('.qty-input').value;
      const submitBtn = addToCartForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;

      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'åŠ å…¥ä¸­...';

      // Get button position for animation
      const btnRect = submitBtn.getBoundingClientRect();
      const startX = btnRect.left + btnRect.width / 2;
      const startY = btnRect.top + btnRect.height / 2;

      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: parseInt(quantity)
        })
      })
      .then(res => res.json())
      .then(data => {
        // Trigger fly animation
        if (window.CartButton && window.CartButton.triggerAnimation) {
          window.CartButton.triggerAnimation(startX, startY);
        }

        // Update cart count
        fetch('/cart.js')
          .then(res => res.json())
          .then(cartData => {
            if (window.CartButton && window.CartButton.updateCount) {
              window.CartButton.updateCount(cartData.item_count);
            }
          });

        // Show success feedback
        submitBtn.textContent = 'å·²åŠ å…¥!';
        submitBtn.classList.add('bg-green-600');
        submitBtn.classList.remove('bg-[#C83F49]');

        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          submitBtn.classList.remove('bg-green-600');
          submitBtn.classList.add('bg-[#C83F49]');
        }, 1500);
      })
      .catch(err => {
        console.error('Add to cart error:', err);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      });
    });
  }
});
</script>

{% schema %}
{
  "name": "ç”¢å“è©³æƒ… (Company)",
  "tag": "section",
  "class": "product-detail-company",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_related",
      "label": "é¡¯ç¤ºç›¸é—œç”¢å“",
      "default": true
    }
  ]
}
{% endschema %}
