{% comment %}
  Company mode product grid section
  Voucher-style product cards in a responsive grid
{% endcomment %}

<section id="MainContent" class="bg-transparent relative z-10 w-full max-w-7xl mx-auto px-4 md:px-12 py-24 space-y-24 md:space-y-32">
  <!-- Product Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    {%- for product in collections[section.settings.collection].products limit: section.settings.products_limit -%}
      {% render 'product-card-company', product: product, index: forloop.index0 %}
    {%- else -%}
      {%- for i in (1..3) -%}
        <div class="scroll-reveal group cursor-pointer flex flex-col h-full">
          <div class="flex-grow border-2 border-[#EAEAEA] relative bg-[#F9F9F9] p-2">
            <div class="h-full border border-[#333]/10 p-4 flex flex-col">
              <div class="w-full aspect-square mb-6 bg-gradient-to-b from-[#f5f5f0] to-[#e8e6dc]">
                {{ 'product-1' | placeholder_svg_tag: 'w-full h-full' }}
              </div>
              <div class="text-center">
                <h3 class="text-2xl font-lhkk font-black text-[#333] mb-4">示例產品</h3>
                <p class="text-sm text-[#333]/80">請在設定中選擇產品系列</p>
              </div>
            </div>
          </div>
        </div>
      {%- endfor -%}
    {%- endfor -%}
  </div>

  <!-- Introduction Block -->
  <section class="grid grid-cols-1 md:grid-cols-12 gap-0 border-t border-b border-[#B08D57]/30">
    <!-- Red Title Block -->
    <div class="md:col-span-3 p-6 md:p-8 border-b md:border-b-0 md:border-r border-[#B08D57]/30 flex items-center justify-center bg-[#C83F49]/5 relative overflow-hidden">
      <!-- Decorative Pattern -->
      <div class="absolute inset-0 opacity-10 bg-[radial-gradient(#C83F49_1px,transparent_1px)] [background-size:16px_16px]"></div>

      <div class="relative z-10 border-2 border-[#C83F49] p-2 md:p-4">
        <h2 class="text-2xl md:text-5xl font-lhkk font-black tracking-wider md:tracking-widest writing-vertical-rl text-[#C83F49]">
          {{ section.settings.intro_title | default: '歲月滋味' }}
        </h2>
      </div>
    </div>

    <!-- Text Block -->
    <div class="md:col-span-9 p-8 md:p-12 flex flex-col justify-center bg-white/90 backdrop-blur-sm">
      <div class="flex items-center gap-4 mb-6">
        <span class="text-[#B08D57] font-mono text-xs tracking-[0.3em] uppercase border border-[#B08D57] px-2 py-1">
          {{ section.settings.intro_tag | default: 'Lunar New Year Collection' }}
        </span>
        <div class="h-px flex-grow bg-[#B08D57]/20"></div>
      </div>
      <p class="font-lhkk text-lg leading-loose text-[#333]/80 mb-8 max-w-xl">
        {{ section.settings.intro_text | default: '味覺是記憶的鑰匙。新春將至，我們以傳統活版印刷的精神，打磨每一份糕點。不只是食物，更是對來年最厚重的祝福。' }}
      </p>
      <div class="flex gap-2">
        <div class="w-2 h-2 bg-[#C83F49]"></div>
        <div class="w-2 h-2 bg-[#B08D57]"></div>
      </div>
    </div>
  </section>
</section>

<script>
  // Scroll Reveal Animation
  document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.scroll-reveal').forEach(el => observer.observe(el));

    // Product card click handler
    document.querySelectorAll('[data-product-url]').forEach(card => {
      card.addEventListener('click', function(e) {
        if (!e.target.closest('.add-to-cart-btn')) {
          window.location.href = this.dataset.productUrl;
        }
      });
    });

    // Add to cart handler
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const variantId = this.dataset.variantId;
        const originalText = this.textContent;

        // Disable button and show loading
        this.disabled = true;
        this.textContent = '加入中...';

        // Get button position for animation
        const btnRect = this.getBoundingClientRect();
        const startX = btnRect.left + btnRect.width / 2;
        const startY = btnRect.top + btnRect.height / 2;

        // Shopify AJAX Cart API
        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        })
        .then(res => res.json())
        .then(data => {
          // Trigger fly animation
          if (window.CartButton && window.CartButton.triggerAnimation) {
            window.CartButton.triggerAnimation(startX, startY);
          }

          // Update cart count
          fetch('/cart.js')
            .then(res => res.json())
            .then(cartData => {
              if (window.CartButton && window.CartButton.updateCount) {
                window.CartButton.updateCount(cartData.item_count);
              }
            });

          // Show success feedback
          this.textContent = '已加入!';

          setTimeout(() => {
            this.disabled = false;
            this.textContent = originalText;
          }, 1500);
        })
        .catch(err => {
          console.error('Add to cart error:', err);
          this.disabled = false;
          this.textContent = originalText;
        });
      });
    });
  });
</script>

{% schema %}
{
  "name": "產品網格 (Company)",
  "tag": "section",
  "class": "product-grid-company",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "產品系列"
    },
    {
      "type": "range",
      "id": "products_limit",
      "min": 3,
      "max": 12,
      "step": 3,
      "default": 6,
      "label": "顯示產品數量"
    },
    {
      "type": "text",
      "id": "intro_title",
      "label": "介紹標題",
      "default": "歲月滋味"
    },
    {
      "type": "text",
      "id": "intro_tag",
      "label": "介紹標籤",
      "default": "Lunar New Year Collection"
    },
    {
      "type": "textarea",
      "id": "intro_text",
      "label": "介紹文字",
      "default": "味覺是記憶的鑰匙。新春將至，我們以傳統活版印刷的精神，打磨每一份糕點。不只是食物，更是對來年最厚重的祝福。"
    }
  ],
  "presets": [
    {
      "name": "產品網格 (Company)"
    }
  ]
}
{% endschema %}
